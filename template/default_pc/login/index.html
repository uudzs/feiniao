{extend name="common/base"/}
{block name="style"}
<link rel="stylesheet" href="{__STATIC__}/home/style/login.css?v={$version}">
{/block}
{block name="title"}
<title>登录-{$conf.title}</title>	
{/block}
{block name="body"}
<div class="main-body">
    <div class="login-main">
        <div class="login-top">
            <span>{:get_system_config('web','title')}登录</span>
            <span class="bg1"></span>
            <span class="bg2"></span>
        </div>
        <div class="layui-form login-bottom">
            <div class="center">
                <div class="item">
                    <span class="icon icon-2"></span>
                    <input type="text" name="username" lay-verify="required" placeholder="请输入登录账号" maxlength="24">
                </div>
                <div class="item">
                    <span class="icon icon-3"></span>
                    <input type="password" name="password" lay-verify="required" placeholder="请输入密码" maxlength="20">
                    <span class="bind-password icon icon-4"></span>
                </div>
                <div id="validatePanel" class="item" style="width: 137px;">
                    <span class="icon icon-7"></span>
                    <input type="text" name="captcha" placeholder="请输入验证码" maxlength="6">
                    <img id="refreshCaptcha" class="validateImg" src="{:furl('v1/captcha', [], true, 'api')}" onclick="this.src='{:furl('v1/captcha', [], true, 'api')}?seed='+Math.random()">
                </div>              
            </div>
            <div class="layui-form-item" style="text-align:center; width:100%;height:100%;margin:0px;">
                <button class="login-btn" lay-submit="" lay-filter="login" style="margin-top: 0;">立即登录</button>
            </div>
            <div class="layui-form-item" style="text-align:center; margin-top: 20px;">
                <a href="{:url('register')}">没有账号？前往注册</a>
            </div>
        </div>
    </div>
</div>
{/block}
{block name="script"}
<script>
    $(window).on('load', function () {
        var refererUrl = '{$refererUrl}';
        layui.use(['form', 'jquery'], function () {
            var $ = layui.jquery,
            form = layui.form,
            layer = layui.layer;
           
            form.on('submit(login)', function (data) {
                data = data.field;               
                if (data.username == '') {
                    layer.msg('用户名不能为空');
                    return false;
                }
                if (data.password == '') {
                    layer.msg('密码不能为空');
                    return false;
                }
                if (data.captcha == '') {
                    layer.msg('验证码不能为空');
                    return false;
                }
                let layerIndex = layer.load();
                var invite_code = $.getCookie(sessioninvitename);
                var postData = {"username": data.username, "password": data.password, "code": data.captcha, "invite_code": invite_code};
                $.postApi("{:furl('v1/login', [], true, 'api')}", postData, function(result) {
                    layer.close(layerIndex);
                    layer.msg(result.msg);
                    if(parseInt(result.code) == 0) {
                        layui.data('feiniao', {
                            key: 'token',
                            value: result.data.token
                        });
                        window.location.href = refererUrl;
                    } else {
                        $('#refreshCaptcha').attr("src", "{:furl('v1/captcha', [], true, 'api')}" + "?" + Math.random());
                    }
                });                
            });
            return false;
        });
        $('.bind-password').on('click', function () {            
            if ($(this).hasClass('icon-5')) {
                $(this).removeClass('icon-5');
                $("input[name='password']").attr('type', 'password');
            } else {
                $(this).addClass('icon-5');
                $("input[name='password']").attr('type', 'text');
            }
        });       
    });
</script>
{/block}